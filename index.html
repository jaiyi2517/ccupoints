<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>計分白板</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 React 與 React DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 載入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 載入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Covered+By+Your+Grace&family=Knewave&family=Noto+Sans+TC:wght@400;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* 基礎樣式重置 */
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden; /* 禁止整體滾動 */
            height: 100%;
            touch-action: none; /* 防止瀏覽器預設觸控行為 */
            -webkit-user-select: none; /* Safari 禁止選取 */
        }
        #root {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // 模擬 Lucide React 圖示組件 (SVG)
        const Eraser = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>
        );
        const X = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        // 自定義字體樣式與動畫 CSS
        const FontStyles = () => (
            <style>{`
                /* 字體策略 */
                .font-marker { 
                font-family: 'Knewave', 'Noto Sans TC', sans-serif; 
                }
                .font-hand { 
                font-family: 'Covered By Your Grace', 'Noto Serif TC', cursive; 
                }
                .font-tw-bold {
                font-family: 'Noto Sans TC', sans-serif;
                font-weight: 700;
                }
                .font-tw-serif-bold {
                font-family: 'Noto Serif TC', serif;
                font-weight: 700;
                }

                /* 白板背景紋理 */
                .whiteboard-bg {
                background-color: #f8f9fa;
                background-image: 
                    linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
                background-size: 40px 40px;
                position: relative;
                }
                .whiteboard-bg::before {
                content: "";
                position: absolute;
                top: 0; left: 0; right: 0; bottom: 0;
                background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 40%);
                pointer-events: none;
                z-index: 1; 
                }

                /* 塗改效果動畫 */
                @keyframes smudge {
                0% { opacity: 0; transform: scale(0.8) rotate(0deg); }
                20% { opacity: 0.8; transform: scale(1.1) rotate(-5deg); }
                40% { opacity: 0.9; transform: scale(1.1) rotate(5deg); }
                60% { opacity: 0.8; transform: scale(1.1) rotate(-3deg); }
                100% { opacity: 0; transform: scale(1) rotate(0deg); }
                }
                .animate-smudge {
                animation: smudge 0.6s ease-out forwards;
                }

                /* 升級版磁鐵樣式：#355d79 */
                .magnet {
                background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 50%), #355d79; 
                box-shadow: 
                    0 4px 6px rgba(0,0,0,0.4), 
                    inset 0 -4px 6px rgba(0,0,0,0.3), 
                    inset 0 2px 4px rgba(255,255,255,0.3);
                border: 1px solid rgba(255,255,255,0.2);
                transition: transform 0.1s, box-shadow 0.1s;
                cursor: grab;
                position: relative;
                touch-action: none; /* 重要：防止觸控時滾動 */
                }
                .magnet::after {
                content: '';
                position: absolute;
                top: 15%;
                left: 15%;
                width: 20%;
                height: 10%;
                background: rgba(255,255,255,0.4);
                border-radius: 50%;
                transform: rotate(-45deg);
                pointer-events: none;
                }
                
                .magnet:active {
                cursor: grabbing;
                transform: scale(0.95);
                box-shadow: 0 2px 3px rgba(0,0,0,0.3), inset 0 -2px 4px rgba(0,0,0,0.2);
                }

                /* 幽靈磁鐵 (拖曳中) */
                .ghost-magnet {
                    position: fixed;
                    z-index: 9999;
                    pointer-events: none;
                    opacity: 0.9;
                    transform: translate(-50%, -50%) scale(1.2);
                }

                /* 雜亂線圈 Hover 效果 */
                .scribble-hover {
                position: relative;
                }
                .scribble-hover::after {
                content: '';
                position: absolute;
                top: -10%; left: -10%; width: 120%; height: 120%;
                border: 2px solid transparent;
                border-radius: 50% 40% 60% 50% / 40% 50% 50% 60%;
                transition: all 0.3s ease;
                pointer-events: none;
                opacity: 0;
                }
                .scribble-hover:hover::after, .scribble-hover.active::after {
                border-color: currentColor;
                transform: rotate(-2deg);
                opacity: 0.6;
                }

                /* 隱藏 Scrollbar */
                .no-scrollbar::-webkit-scrollbar {
                display: none;
                }
                .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
                }
                
                /* Modal 動畫 */
                @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.95); }
                to { opacity: 1; transform: scale(1); }
                }
                .animate-fade-in {
                animation: fadeIn 0.2s ease-out forwards;
                }
            `}</style>
        );

        // 背景塗鴉組件
        const BackgroundDoodles = () => {
          // 使用 useMemo 生成隨機的背景裝飾元素，避免重複渲染時閃爍
          const doodles = useMemo(() => {
            const symbols = ['❆', '⍋', '⛧'];
            // 生成 15 個隨機分佈的裝飾
            return Array.from({ length:15 }).map((_, i) => ({
              id: i,
              symbol: symbols[Math.floor(Math.random() * symbols.length)],
              top: `${Math.random() * 95}%`,
              left: `${Math.random() * 95}%`,
              rotation: `${Math.random() * 60 - 30}deg`, // -30 到 30 度隨機旋轉
              size: `${Math.floor(Math.random() * 1 + 2)}rem` // 3rem 到 5rem 隨機大小
            }));
          }, []);

          return (
            <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
                <svg className="absolute top-10 -left-10 w-64 h-64 opacity-[0.15] transform -rotate-12 text-gray-600" viewBox="0 0 100 100">
                <circle cx="45" cy="45" r="40" fill="none" stroke="currentColor" strokeWidth="2" />
                <path d="M25 30 Q45 50 25 70" fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="3,3" />
                <path d="M75 30 Q55 50 75 70" fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="3,3" />
                </svg>

                <svg className="absolute bottom-60 right-5 w-48 h-48 opacity-[0.1] text-green-700 transform rotate-6" viewBox="0 0 100 100">
                <path d="M50 10 L80 40 H60 L85 70 H55 L60 90 H40 L45 70 H15 L40 40 H20 Z" fill="none" stroke="currentColor" strokeWidth="2" strokeLinejoin="round"/>
                <circle cx="50" cy="10" r="3" fill="currentColor" opacity="0.4" />
                <circle cx="30" cy="50" r="2" fill="currentColor" opacity="0.4" />
                <circle cx="70" cy="60" r="2" fill="currentColor" opacity="0.4" />
                </svg>


                {/* 隨機散佈的文字裝飾元素 */}
                {doodles.map((item) => (
                  <div 
                    key={item.id}
                    className="absolute text-blue-200 opacity-30 font-hand"
                    style={{
                      top: item.top,
                      left: item.left,
                      fontSize: item.size,
                      transform: `rotate(${item.rotation})`
                    }}
                  >
                    {item.symbol}
                  </div>
                ))}
            </div>
          );
        };

        // 聖誕帽組件
        const SantaHat = () => (
        <svg className="absolute -top-9 -left-4 w-10 h-10 transform -rotate-12 pointer-events-none" viewBox="0 0 50 50">
            <path d="M10 40 L25 10 L40 40 Q25 45 10 40 Z" fill="#D32F2F" />
            <circle cx="25" cy="8" r="4" fill="white" />
            <rect x="8" y="38" width="34" height="8" rx="4" fill="white" />
        </svg>
        );

        const App = () => {
            const initialTeams = [
                { id: 't1', name: '第一小隊', score: 0, color: '#B71C1C', history: [] }, // 深戰術紅
                { id: 't2', name: '第二小隊', score: 0, color: '#0D47A1', history: [] }, // 深策略藍
                { id: 't3', name: '第三小隊', score: 0, color: '#1B5E20', history: [] }, // 深活力綠
            ];

            const [teams, setTeams] = useState(initialTeams);
            const [selectedTeamId, setSelectedTeamId] = useState(null);
            const [draggedValue, setDraggedValue] = useState(null);
            const [resetTarget, setResetTarget] = useState(null);
            const [updatingTeamId, setUpdatingTeamId] = useState(null);
            
            // 觸控拖曳狀態
            const [touchDrag, setTouchDrag] = useState({ active: false, x: 0, y: 0, value: null });

            const confirmReset = () => {
                if (resetTarget === 'all') {
                setTeams(initialTeams);
                setSelectedTeamId(null);
                } else if (resetTarget) {
                setTeams(prevTeams => prevTeams.map(t => 
                    t.id === resetTarget ? { ...t, score: 0, history: [] } : t
                ));
                }
                setUpdatingTeamId(null);
                setResetTarget(null);
            };

            const handleNameChange = (id, newName) => {
                setTeams(teams.map(t => t.id === id ? { ...t, name: newName } : t));
            };

            const addScore = (teamId, points) => {
                setUpdatingTeamId(teamId);
                setTimeout(() => setUpdatingTeamId(null), 600);
                setTeams(prevTeams => prevTeams.map(team => {
                if (team.id === teamId) {
                    return {
                    ...team,
                    score: team.score + points,
                    history: [...team.history, { val: points, id: Date.now() + Math.random() }]
                    };
                }
                return team;
                }));
            };

            // HTML5 Drag Handlers (Desktop)
            const handleDragStart = (e, value) => {
                setDraggedValue(value);
                e.dataTransfer.effectAllowed = "copy";
            };
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (e, teamId) => {
                e.preventDefault();
                if (draggedValue) {
                    addScore(teamId, draggedValue);
                    setDraggedValue(null);
                }
            };

            // Touch Drag Handlers (Mobile)
            const handleTouchStart = (e, value) => {
                e.stopPropagation();
                const touch = e.touches[0];
                setTouchDrag({
                    active: true,
                    x: touch.clientX,
                    y: touch.clientY,
                    value: value
                });
            };

            const handleTouchMove = (e) => {
                if (!touchDrag.active) return;
                // 防止螢幕捲動
                if (e.cancelable) e.preventDefault(); 
                e.stopPropagation();
                
                const touch = e.touches[0];
                setTouchDrag(prev => ({ ...prev, x: touch.clientX, y: touch.clientY }));
            };

            const handleTouchEnd = (e) => {
                if (!touchDrag.active) return;
                e.stopPropagation();

                // 檢測手指放開位置的元素
                const touch = e.changedTouches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                
                // 尋找最近的隊伍區塊
                const teamDiv = target?.closest('[data-team-id]');
                
                if (teamDiv) {
                    const teamId = teamDiv.getAttribute('data-team-id');
                    addScore(teamId, touchDrag.value);
                } else {
                    // 如果沒有拖到隊伍區，視為點擊
                    handleMagnetClick(touchDrag.value);
                }

                setTouchDrag({ active: false, x: 0, y: 0, value: null });
            };

            const handleTeamClick = (teamId) => {
                setSelectedTeamId(teamId === selectedTeamId ? null : teamId);
            };

            const handleMagnetClick = (value) => {
                if (selectedTeamId) {
                    addScore(selectedTeamId, value);
                } else {
                    const header = document.getElementById('instruction-text');
                    if(header) {
                        header.classList.add('animate-bounce');
                        setTimeout(() => header.classList.remove('animate-bounce'), 1000);
                    }
                }
            };

            const getModalContent = () => {
                if (resetTarget === 'all') {
                return { title: "全部清除？", desc: "這將會擦掉「所有小隊」的分數紀錄，無法復原喔！" };
                } else {
                const targetTeam = teams.find(t => t.id === resetTarget);
                return { title: `清除 ${targetTeam?.name || '此小隊'}？`, desc: "這將會歸零該小隊的分數與紀錄，確定要擦掉嗎？" };
                }
            };

            return (
                // 修正：使用 fixed inset-0 與 h-[100dvh] 來確保在手機瀏覽器上能正確填滿視窗，不被工具列遮擋
                <div className="fixed inset-0 h-[100dvh] w-full whiteboard-bg font-sans text-gray-800 flex flex-col overflow-hidden select-none relative">
                <FontStyles />
                <BackgroundDoodles />

                {/* Ghost Magnet for Touch Drag */}
                {touchDrag.active && (
                    <div 
                        className="magnet w-16 h-16 rounded-full flex items-center justify-center text-3xl font-marker text-white ghost-magnet shadow-2xl"
                        style={{ left: touchDrag.x, top: touchDrag.y }}
                    >
                        {touchDrag.value}
                    </div>
                )}

                {/* Modal */}
                {resetTarget && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full animate-fade-in border-4 border-gray-200 transform rotate-1">
                        <h3 className="text-2xl font-bold text-gray-800 mb-2 font-tw-bold">{getModalContent().title}</h3>
                        <p className="text-gray-600 mb-6 font-hand text-xl">{getModalContent().desc}</p>
                        <div className="flex gap-4 justify-end">
                        <button onClick={() => setResetTarget(null)} className="px-4 py-2 rounded-lg border-2 border-gray-300 text-gray-600 hover:bg-gray-100 font-bold flex items-center gap-2 transition-colors">
                            <X size={20} /> 取消
                        </button>
                        <button onClick={confirmReset} className="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow-md font-bold flex items-center gap-2 transition-transform active:scale-95">
                            <Eraser size={20} /> 擦乾淨
                        </button>
                        </div>
                    </div>
                    </div>
                )}

                {/* Header */}
                <header className="flex-none relative z-10 flex justify-between items-center p-3 md:p-6 border-b-2 border-gray-300/50">
                    <div className="relative transform -rotate-1">
                    <h1 className="text-3xl md:text-6xl font-marker text-gray-800 tracking-wider relative z-10 px-2 py-1">
                        <span className="relative inline-block">
                        S
                        <SantaHat />
                        </span>
                        coring Board
                        <svg className="absolute top-0 left-0 w-full h-full -z-10 pointer-events-none overflow-visible" viewBox="0 0 300 60">
                        <path d="M10,20 Q150,-10 290,25 Q280,65 150,55 Q20,60 10,20" fill="none" stroke="#D32F2F" strokeWidth="3" strokeLinecap="round" strokeDasharray="600" style={{strokeDashoffset: 0}} />
                        </svg>
                    </h1>
                    <p className="text-gray-600 text-sm md:text-xl ml-2 md:ml-4 mt-1 font-hand font-bold tracking-wide">今日戰況 / Today's Battle</p>
                    </div>
                    <button onClick={() => setResetTarget('all')} className="group flex flex-col items-center gap-1 transition-transform hover:rotate-6 active:scale-95" title="全部清除">
                    <div className="bg-[#355d79] text-white p-2 md:p-3 rounded shadow-lg border-b-4 border-[#254155] flex items-center justify-center w-12 h-8 md:w-16 md:h-10 relative overflow-hidden">
                        <div className="absolute inset-0 bg-white/10 skew-x-12 -ml-4"></div>
                        <Eraser size={18} />
                    </div>
                    <span className="text-[10px] md:text-xs font-bold text-gray-500 font-tw-bold">全部清除</span>
                    </button>
                </header>

                {/* Main Board - 改為 flex-row 以維持手機三欄顯示，移除 gap-1 改為 gap-0 */}
                <main className="flex-1 flex flex-row relative z-10 p-1 md:p-4 gap-0 overflow-hidden">
                    {teams.map((team, index) => (
                    <div 
                        key={team.id}
                        data-team-id={team.id}
                        onDragOver={handleDragOver}
                        onDrop={(e) => handleDrop(e, team.id)}
                        onClick={() => handleTeamClick(team.id)}
                        className={`
                        flex-1 flex flex-col items-center justify-start relative transition-all duration-300 min-h-0
                        /* 調整分隔線：加深顏色 border-gray-400，確保可見 */
                        ${index !== teams.length - 1 ? 'border-r-2 border-gray-400 border-dashed' : ''}
                        ${selectedTeamId === team.id ? 'bg-yellow-50/50 ring-2 md:ring-4 ring-yellow-400/30 rounded-lg' : ''}
                        hover:bg-gray-50/30 group/team
                        `}
                    >
                        {selectedTeamId === team.id && (
                            <div className="absolute inset-1 border-2 md:border-4 border-blue-400/20 rounded-lg pointer-events-none" style={{ borderRadius: '15px 20px 10px 15px' }}></div>
                        )}

                        {/* 隊名 & 清除按鈕 */}
                        <div className="mt-2 md:mt-6 w-full px-1 md:w-3/4 flex items-end justify-center relative shrink-0">
                        <div className="relative w-full text-center">
                            <input
                            type="text"
                            value={team.name}
                            onChange={(e) => handleNameChange(team.id, e.target.value)}
                            className="w-full text-center text-lg md:text-4xl font-tw-serif-bold bg-transparent border-b border-gray-800 focus:border-blue-500 outline-none pb-1 text-gray-700 transition-colors"
                            style={{ borderColor: selectedTeamId === team.id ? team.color : 'rgba(0,0,0,0.6)' }}
                            />
                        </div>
                        <button
                            onClick={(e) => {
                            e.stopPropagation();
                            setResetTarget(team.id);
                            }}
                            className="absolute -right-1 md:-right-6 top-1 text-gray-300 hover:text-red-500 hover:bg-red-50 p-1 rounded-full transition-all md:opacity-0 group-hover/team:opacity-100"
                        >
                            <Eraser size={16} />
                        </button>
                        </div>

                        {/* 分數顯示區 */}
                        <div className="my-1 md:my-4 relative w-full flex-1 flex items-center justify-center shrink min-h-0">
                        {updatingTeamId === team.id && (
                            <div className="absolute inset-0 flex items-center justify-center z-20 animate-smudge pointer-events-none">
                            <div className="w-24 h-16 md:w-32 md:h-24 bg-gray-200/80 blur-md rounded-full transform rotate-12"></div>
                            </div>
                        )}
                        <div className="text-5xl md:text-9xl font-marker transition-all duration-300 drop-shadow-sm leading-none" style={{ color: team.color }}>
                            {team.score}
                        </div>
                        </div>

                        {/* 得分歷程 (History) - 手機版縮小圓點 */}
                        <div className="w-full px-1 md:px-4 mb-2 relative shrink-0">
                            <div className="flex flex-wrap justify-center gap-1 md:gap-2 content-start p-1 md:p-4 bg-white/30 rounded-lg border border-gray-200/50 border-dashed h-12 md:h-auto overflow-y-auto no-scrollbar">
                            {team.history.map((record) => (
                                <div 
                                key={record.id}
                                className="w-4 h-4 md:w-8 md:h-8 rounded-full flex items-center justify-center font-bold text-white text-[8px] md:text-sm shadow-sm cursor-default font-sans"
                                style={{ backgroundColor: team.color }}
                                >
                                {record.val}
                                </div>
                            ))}
                            </div>
                        </div>
                    </div>
                    ))}
                </main>

                {/* Footer Controls */}
                {/* 增加底部 padding pb-4 md:pb-6 以應對手機下方 Home Bar */}
                <footer className="flex-none relative z-20 bg-gray-100/90 border-t-4 border-gray-300 p-2 pb-4 md:p-6 shadow-2xl safe-area-bottom">
                    <div className="max-w-5xl mx-auto">
                    {/* 操作說明 */}
                    <div id="instruction-text" className="text-center mb-2 md:mb-4 text-gray-400 text-[12px] md:text-sm font-hand flex flex-wrap items-center justify-center gap-2 opacity-80">
                        <span>直接拖曳磁鐵 或 點選組別+按數字</span>
                    </div>
                    
                    <div className="flex flex-wrap justify-center gap-2 md:gap-6">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((num) => (
                        <div
                            key={num}
                            draggable
                            onDragStart={(e) => handleDragStart(e, num)}
                            onClick={() => handleMagnetClick(num)}
                            onTouchStart={(e) => handleTouchStart(e, num)}
                            onTouchMove={handleTouchMove}
                            onTouchEnd={handleTouchEnd}
                            className={`
                            magnet w-10 h-10 md:w-16 md:h-16 rounded-full 
                            flex items-center justify-center 
                            text-xl md:text-3xl font-marker text-white
                            scribble-hover
                            transition-transform active:scale-90
                            `}
                            style={{ paddingTop: '2px' }}
                        >
                            {num}
                        </div>
                        ))}
                    </div>
                    </div>
                </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
